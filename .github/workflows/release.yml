name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run tests
        run: |
          pytest src/ -v --tb=short
  
  build-launcher:
    runs-on: windows-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dist.txt
      
      - name: Build React UI
        working-directory: src/ui/behind-the-sena
        run: |
          npm install --quiet
          npm run build
      
      - name: Build launcher executable
        run: |
          pyinstaller `
            --name "Sena" `
            --onefile `
            --windowed `
            --add-data "assets:assets" `
            --add-data "src:src" `
            --add-data "src/ui/behind-the-sena/dist:src/ui/behind-the-sena/dist" `
            --hidden-import=uvicorn `
            --hidden-import=fastapi `
            --hidden-import=pydantic `
            --icon="assets/sena-logo.png" `
            launcher.js
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Sena.exe
          draft: false
          prerelease: false
          body: |
            # Sena v${{ github.ref_name }}
            
            ## What's New
            See [CHANGELOG.md](CHANGELOG.md) for details.
            
            ## Installation
            1. Download `Sena.exe` below
            2. Run the executable
            3. The app will start automatically
            
            ## Support
            - üìñ [Documentation](https://github.com/${{ github.repository }}/wiki)
            - üêõ [Report Issues](https://github.com/${{ github.repository }}/issues)
            - üí¨ [Discussions](https://github.com/${{ github.repository }}/discussions)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
